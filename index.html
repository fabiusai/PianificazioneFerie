<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Ferie Smart</title>
    <link rel="icon" href="favicon.ico">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* --- Header & Tabs --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 1.8rem;
            color: var(--primary-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .year-tabs {
            display: flex;
            background: #e2e8f0;
            padding: 4px;
            border-radius: var(--radius);
        }

        .year-tab {
            padding: 8px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .year-tab.active {
            background: var(--bg-card);
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* --- Grid Layout --- */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .main-grid { grid-template-columns: 1fr; }
        }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .card h2 {
            font-size: 1.1rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--bg-body);
            padding-bottom: 10px;
        }

        /* --- Spettanze Inputs --- */
        .spettanza-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .spettanza-row input {
            width: 70px;
            padding: 6px;
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            color: var(--primary);
        }

        /* --- Summary Dashboard --- */
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .summary-item.total {
            font-weight: bold;
            border-top: 1px dashed var(--border);
            padding-top: 8px;
            margin-top: 8px;
            color: var(--primary-dark);
        }

        .badge-residuo {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        .bg-ok { background-color: #dcfce7; color: #166534; }
        .bg-warn { background-color: #fee2e2; color: #991b1b; }

        /* --- Input Bar (New Record) --- */
        .input-bar {
            display: flex;
            gap: 10px;
            background: #f8fafc;
            padding: 15px;
            border-radius: var(--radius);
            border: 1px dashed var(--primary);
            align-items: end;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
            min-width: 150px;
        }

        .input-group label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .input-group input, .input-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn-add {
            background-color: var(--primary);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            height: 45px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .btn-add:disabled { background-color: #cbd5e1; cursor: not-allowed; }
        .btn-add:hover:not(:disabled) { background-color: var(--primary-dark); }

        /* --- Table --- */
        .table-wrapper {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            text-align: left;
            padding: 12px;
            color: var(--text-muted);
            font-size: 0.85rem;
            border-bottom: 2px solid var(--border);
        }
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        tr:hover td { background-color: #f8fafc; }

        .status-toggle {
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--border);
            transition: color 0.2s;
        }
        .status-toggle.active { color: var(--success); }

        .btn-del {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .btn-del:hover { color: var(--danger); }

        /* --- Footer Actions --- */
        .actions-bar {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn:hover { background: #f1f5f9; }
        .btn-outline-danger { color: var(--danger); border-color: var(--danger); }
        .btn-outline-danger:hover { background: #fef2f2; }

        /* --- Config Modal --- */
        .year-config {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1><i class="fa-solid fa-plane-departure"></i> Piano Ferie</h1>
            <div class="year-tabs" id="year-tabs-container">
                </div>
        </header>

        <div class="year-config" id="config-area">
            <label>Anno di Riferimento (Start):</label>
            <input type="number" id="base-year-input" style="width: 80px; padding: 5px;" min="2020" max="2050">
            <button class="btn" id="update-year-btn">Aggiorna</button>
        </div>

        <div class="main-grid">
            <aside>
                <div class="card">
                    <h2><i class="fa-solid fa-scale-balanced"></i> Spettanze <span id="lbl-active-year"></span></h2>
                    <div id="spettanze-container">
                        </div>
                    <div class="summary-item total">
                        <span>Totale Disponibile</span>
                        <span id="total-spettanze">0</span>
                    </div>
                </div>

                <div class="card">
                    <h2><i class="fa-solid fa-chart-pie"></i> Riepilogo</h2>
                    <div id="summary-dashboard">
                        </div>
                </div>
            </aside>

            <main>
                <div class="card">
                    <h2><i class="fa-solid fa-calendar-plus"></i> Nuova Pianificazione</h2>
                    <div class="input-bar">
                        <div class="input-group">
                            <label>Data</label>
                            <input type="date" id="new-date">
                        </div>
                        <div class="input-group">
                            <label>Tipologia</label>
                            <select id="new-type">
                                <option value="ferie">Ferie</option>
                                <option value="festivita">Festività soppresse</option>
                                <option value="pir">PIR</option>
                                <option value="smonetizzazione">Smonetizzazione</option>
                            </select>
                        </div>
                        <button id="btn-add-record" class="btn-add" disabled>
                            <i class="fa-solid fa-plus"></i> Aggiungi
                        </button>
                    </div>
                    <div id="validation-msg" style="color: var(--danger); font-size: 0.9rem; margin-top: -15px; margin-bottom: 15px; display: none;"></div>

                    <h2><i class="fa-solid fa-list-check"></i> Elenco Assenze</h2>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Giorno</th>
                                    <th>Tipo</th>
                                    <th style="text-align: center">Fruito</th>
                                    <th style="text-align: right">Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                </tbody>
                        </table>
                    </div>
                    <div id="empty-state" style="text-align: center; padding: 40px; color: var(--text-muted); display: none;">
                        Nessuna assenza pianificata per questo anno.
                    </div>
                </div>

                <div class="actions-bar">
                    <button id="btn-export" class="btn"><i class="fa-solid fa-file-excel" style="color: green"></i> Esporta Excel</button>
                    <button id="btn-import" class="btn"><i class="fa-solid fa-file-import"></i> Importa Excel</button>
                    <input type="file" id="file-input" accept=".xlsx, .xls" hidden>
                    <div style="flex-grow: 1"></div>
                    <button id="btn-reset-year" class="btn btn-outline-danger"><i class="fa-solid fa-trash"></i> Resetta Anno Corrente</button>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE E STATO ---
        const CONFIG = {
            storageKey: 'ferieApp_v2',
            festivitaFisse: ['01-01', '01-06', '04-25', '05-01', '06-02', '08-15', '11-01', '12-08', '12-25', '12-26'],
            tipi: {
                ferie: 'Ferie',
                festivita: 'Festività soppresse',
                pir: 'PIR',
                smonetizzazione: 'Smonetizzazione'
            }
        };

        // Struttura Dati Principale
        let appState = {
            baseYear: new Date().getFullYear(),
            // I dati sono salvati per anno: { 2024: { spettanze: {...}, assenze: [...] }, 2025: ... }
            yearsData: {}
        };

        let currentViewYear = null; // Anno attualmente visualizzato nel tab

        // --- INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initUI();
        });

        function initUI() {
            // Setup Tab Base Year
            document.getElementById('base-year-input').value = appState.baseYear;
            currentViewYear = appState.baseYear;

            renderTabs();
            renderYearView();

            // Event Listeners Globali
            document.getElementById('update-year-btn').addEventListener('click', updateBaseYear);
            document.getElementById('new-date').addEventListener('input', validateInput);
            document.getElementById('new-type').addEventListener('change', validateInput);
            document.getElementById('btn-add-record').addEventListener('click', addRecord);
            document.getElementById('btn-export').addEventListener('click', exportExcel);
            document.getElementById('btn-import').addEventListener('click', () => document.getElementById('file-input').click());
            document.getElementById('file-input').addEventListener('change', importExcel);
            document.getElementById('btn-reset-year').addEventListener('click', resetCurrentYear);
        }

        // --- GESTIONE DATI (LOAD/SAVE/MIGRATE) ---
        function loadData() {
            const raw = localStorage.getItem(CONFIG.storageKey);
            if (raw) {
                appState = JSON.parse(raw);
            } else {
                // Tenta migrazione dalla vecchia versione
                const oldData = localStorage.getItem('consuntivazioneApp');
                if (oldData) {
                    migrateData(JSON.parse(oldData));
                } else {
                    // Init vuoto per anno corrente e successivo
                    ensureYearInitialized(appState.baseYear);
                    ensureYearInitialized(appState.baseYear + 1);
                }
            }
        }

        function saveData() {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(appState));
        }

        function ensureYearInitialized(year) {
            if (!appState.yearsData[year]) {
                appState.yearsData[year] = {
                    spettanze: { ferie: 25, festivita: 4, pir: 2, smonetizzazione: 1 },
                    assenze: []
                };
            }
        }

        function migrateData(oldData) {
            console.log("Migrazione dati vecchia versione...");
            const year = appState.baseYear;
            ensureYearInitialized(year);
            
            // Copia spettanze
            if(oldData.spettanze) appState.yearsData[year].spettanze = oldData.spettanze;
            
            // Copia assenze
            if(oldData.assenze && Array.isArray(oldData.assenze)) {
                appState.yearsData[year].assenze = oldData.assenze.map(a => ({
                    id: a.id || Date.now() + Math.random(),
                    data: a.data,
                    tipo: a.tipo,
                    fruito: a.fruito
                })).filter(a => a.data && a.data.startsWith(year)); // Prende solo quelle dell'anno base
            }
            saveData();
        }

        // --- LOGICA DI RENDERIZZAZIONE ---
        function updateBaseYear() {
            const val = parseInt(document.getElementById('base-year-input').value);
            if (val && val > 2000) {
                appState.baseYear = val;
                ensureYearInitialized(val);
                ensureYearInitialized(val + 1);
                currentViewYear = val;
                saveData();
                renderTabs();
                renderYearView();
            }
        }

        function renderTabs() {
            const container = document.getElementById('year-tabs-container');
            container.innerHTML = '';
            
            [appState.baseYear, appState.baseYear + 1].forEach(year => {
                const btn = document.createElement('button');
                btn.className = `year-tab ${year === currentViewYear ? 'active' : ''}`;
                btn.textContent = year;
                btn.onclick = () => {
                    currentViewYear = year;
                    renderTabs();
                    renderYearView();
                };
                container.appendChild(btn);
            });
        }

        function renderYearView() {
            ensureYearInitialized(currentViewYear);
            document.getElementById('lbl-active-year').textContent = currentViewYear;
            
            renderSpettanzeInputs();
            renderTable();
            renderSummary();
            
            // Reset form inserimento
            document.getElementById('new-date').value = '';
            validateInput();
        }

        function renderSpettanzeInputs() {
            const container = document.getElementById('spettanze-container');
            container.innerHTML = '';
            const data = appState.yearsData[currentViewYear].spettanze;

            Object.keys(CONFIG.tipi).forEach(key => {
                const div = document.createElement('div');
                div.className = 'spettanza-row';
                div.innerHTML = `
                    <label>${CONFIG.tipi[key]}</label>
                    <input type="number" value="${data[key]}" onchange="updateSpettanza('${key}', this.value)">
                `;
                container.appendChild(div);
            });

            const total = Object.values(data).reduce((a, b) => a + Number(b), 0);
            document.getElementById('total-spettanze').textContent = total;
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            const list = appState.yearsData[currentViewYear].assenze;
            
            // Ordina per data
            list.sort((a, b) => a.data.localeCompare(b.data));

            if (list.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
                return;
            } else {
                document.getElementById('empty-state').style.display = 'none';
            }

            list.forEach(item => {
                const tr = document.createElement('tr');
                const dateObj = new Date(item.data);
                const dayName = dateObj.toLocaleDateString('it-IT', { weekday: 'long' });
                
                tr.innerHTML = `
                    <td>${dateObj.toLocaleDateString('it-IT')}</td>
                    <td style="text-transform: capitalize">${dayName}</td>
                    <td>${CONFIG.tipi[item.tipo]}</td>
                    <td style="text-align: center">
                        <i class="fa-solid ${item.fruito ? 'fa-circle-check active' : 'fa-circle'} status-toggle" 
                           onclick="toggleFruito(${item.id})"></i>
                    </td>
                    <td style="text-align: right">
                        <button class="btn-del" onclick="deleteRecord(${item.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSummary() {
            const container = document.getElementById('summary-dashboard');
            const data = appState.yearsData[currentViewYear];
            const spettanze = data.spettanze;
            const assenze = data.assenze;

            // Calcoli
            const counts = { pianificati: 0, fruiti: 0 };
            const byType = {};
            
            Object.keys(CONFIG.tipi).forEach(k => byType[k] = { pianificati: 0, fruiti: 0 });

            assenze.forEach(a => {
                if(byType[a.tipo]) {
                    byType[a.tipo].pianificati++;
                    counts.pianificati++;
                    if(a.fruito) {
                        byType[a.tipo].fruito++;
                        counts.fruiti++;
                    }
                }
            });

            let html = '';
            
            // Dettaglio per tipo (Residui)
            Object.keys(CONFIG.tipi).forEach(key => {
                const residuo = spettanze[key] - byType[key].pianificati;
                const badgeClass = residuo >= 0 ? 'bg-ok' : 'bg-warn';
                html += `
                    <div class="summary-item">
                        <span>${CONFIG.tipi[key]}</span>
                        <div>
                            <small class="text-muted">Pian: ${byType[key].pianificati}</small>
                            <span class="badge-residuo ${badgeClass}">Res: ${residuo}</span>
                        </div>
                    </div>
                `;
            });

            // Totali Generali
            const totSpettanze = Object.values(spettanze).reduce((a,b)=>a+Number(b),0);
            const totResiduo = totSpettanze - counts.pianificati;
            
            html += `
                <div class="summary-item total">
                    <span>Totale Pianificati</span>
                    <span>${counts.pianificati}</span>
                </div>
                 <div class="summary-item total">
                    <span>Totale Fruiti</span>
                    <span>${counts.fruiti}</span>
                </div>
                <div class="summary-item total" style="color: ${totResiduo >= 0 ? 'var(--primary-dark)' : 'var(--danger)'}">
                    <span>Residuo Totale da Pianificare</span>
                    <span>${totResiduo}</span>
                </div>
            `;

            container.innerHTML = html;
        }

        // --- AZIONI UTENTE ---
        function updateSpettanza(key, value) {
            appState.yearsData[currentViewYear].spettanze[key] = Number(value);
            saveData();
            renderSpettanzeInputs(); // aggiorna totale
            renderSummary();
        }

        function validateInput() {
            const dateInput = document.getElementById('new-date');
            const addBtn = document.getElementById('btn-add-record');
            const msgBox = document.getElementById('validation-msg');
            const dateVal = dateInput.value;

            msgBox.style.display = 'none';
            addBtn.disabled = true;

            if (!dateVal) return;

            const dateObj = new Date(dateVal);
            const year = dateObj.getFullYear();
            const day = dateObj.getDay(); // 0 Dom, 6 Sab
            const dayMonth = dateVal.slice(5); // MM-DD

            // Controllo 1: Anno congruente col tab
            if (year !== currentViewYear) {
                msgBox.textContent = `Attenzione: Stai visualizzando il ${currentViewYear}, ma hai selezionato una data del ${year}. Cambia Tab o data.`;
                msgBox.style.display = 'block';
                return;
            }

            // Controllo 2: Sabato o Domenica
            if (day === 0 || day === 6) {
                msgBox.textContent = "Non è possibile pianificare ferie di Sabato o Domenica.";
                msgBox.style.display = 'block';
                return;
            }

            // Controllo 3: Festività Fissa
            if (CONFIG.festivitaFisse.includes(dayMonth)) {
                msgBox.textContent = "Data non selezionabile: è una festività nazionale.";
                msgBox.style.display = 'block';
                return;
            }

            // Controllo 4: Duplicati
            const exists = appState.yearsData[currentViewYear].assenze.some(a => a.data === dateVal);
            if (exists) {
                msgBox.textContent = "Esiste già una pianificazione per questa data.";
                msgBox.style.display = 'block';
                return;
            }

            addBtn.disabled = false;
        }

        function addRecord() {
            const dateVal = document.getElementById('new-date').value;
            const typeVal = document.getElementById('new-type').value;

            if (!dateVal) return;

            appState.yearsData[currentViewYear].assenze.push({
                id: Date.now(),
                data: dateVal,
                tipo: typeVal,
                fruito: false
            });

            saveData();
            renderYearView();
        }

        function deleteRecord(id) {
            if(confirm('Eliminare questa voce?')) {
                appState.yearsData[currentViewYear].assenze = 
                    appState.yearsData[currentViewYear].assenze.filter(a => a.id !== id);
                saveData();
                renderYearView();
            }
        }

        function toggleFruito(id) {
            const item = appState.yearsData[currentViewYear].assenze.find(a => a.id === id);
            if(item) {
                item.fruito = !item.fruito;
                saveData();
                renderTable();
                renderSummary();
            }
        }

        function resetCurrentYear() {
            if(confirm(`Sei sicuro di voler CANCELLARE TUTTE le pianificazioni del ${currentViewYear}? Le spettanze rimarranno invariate.`)) {
                appState.yearsData[currentViewYear].assenze = [];
                saveData();
                renderYearView();
            }
        }

        // --- EXPORT / IMPORT EXCEL ---
        function exportExcel() {
            try {
                const wb = XLSX.utils.book_new();

                // 1. Creazione Sheet Dati (tutti gli anni o solo corrente? Esportiamo tutto per backup, ma filtriamo nel nome)
                // Creiamo un foglio unico con tutti i dati storici, ma ordinati
                const allRows = [];
                
                // Iteriamo sugli anni gestiti
                Object.keys(appState.yearsData).sort().forEach(year => {
                    const data = appState.yearsData[year];
                    data.assenze.forEach(a => {
                        allRows.push({
                            'Anno Riferimento': year,
                            'Data': a.data, // Stringa YYYY-MM-DD
                            'Giorno': new Date(a.data).toLocaleDateString('it-IT', {weekday: 'long'}),
                            'Tipologia': CONFIG.tipi[a.tipo],
                            'Stato': a.fruito ? 'Fruito' : 'Pianificato'
                        });
                    });
                });

                // Ordine cronologico
                allRows.sort((a,b) => a.Data.localeCompare(b.Data));

                const wsData = XLSX.utils.json_to_sheet(allRows);
                XLSX.utils.book_append_sheet(wb, wsData, "Diario Assenze");

                // 2. Creazione Sheet Spettanze
                const spettanzeRows = [];
                Object.keys(appState.yearsData).sort().forEach(year => {
                    const s = appState.yearsData[year].spettanze;
                    spettanzeRows.push({
                        'Anno': year,
                        'Ferie': s.ferie,
                        'Festività': s.festivita,
                        'PIR': s.pir,
                        'Smonetizzazione': s.smonetizzazione
                    });
                });
                const wsSpettanze = XLSX.utils.json_to_sheet(spettanzeRows);
                XLSX.utils.book_append_sheet(wb, wsSpettanze, "Spettanze");

                // Naming file: PianoFerie_ANNO_DATA.xlsx
                const today = new Date().toISOString().slice(0,10).replace(/-/g, '');
                const fileName = `PianoFerie_${appState.baseYear}_${today}.xlsx`;

                XLSX.writeFile(wb, fileName);

            } catch (e) {
                alert("Errore export: " + e.message);
            }
        }

        function importExcel() {
            const file = document.getElementById('file-input').files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Logica semplificata: Cerchiamo sheet "Diario Assenze" o "Pianificazione"
                    let sheetName = workbook.SheetNames.find(n => n.includes("Assenze") || n.includes("Pianificazione"));
                    if (!sheetName) throw new Error("Foglio dati non trovato");

                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    
                    if(!confirm(`Trovati ${rows.length} record. Questo sovrascriverà i dati attuali. Continuare?`)) return;

                    // Reset soft
                    appState.yearsData = {}; 

                    rows.forEach(row => {
                        // Supporto importazione vecchio formato (dove Data era oggetto data Excel) o nuovo (Stringa)
                        let dateStr = row['Data'];
                        if (typeof dateStr !== 'string') {
                            // Tentativo conversione data Excel
                            // (SheetJS di solito gestisce date se option cellDates: true non è usato nel read, ma qui usiamo raw)
                             // Se è numero seriale Excel, è complicato senza cellDates, ma proviamo string parsing base
                             // Assumiamo che l'utente stia re-importando un file esportato da questa app
                        }
                        
                        // Normalizza data YYYY-MM-DD
                        if(row['Data'] && row['Data'].match(/^\d{4}-\d{2}-\d{2}$/)) {
                            dateStr = row['Data'];
                        } 
                        
                        if (dateStr) {
                            const y = dateStr.slice(0, 4);
                            ensureYearInitialized(Number(y));
                            
                            // Mappa inversa Tipologia
                            let typeKey = 'ferie';
                            const tVal = row['Tipologia'] || row['Tipologia di Spettanza']; // Compatibilità
                            Object.entries(CONFIG.tipi).forEach(([k, v]) => {
                                if(v === tVal) typeKey = k;
                            });

                            const isFruito = (row['Stato'] === 'Fruito') || (String(row['Fruito']).toLowerCase() === 'si');

                            appState.yearsData[y].assenze.push({
                                id: Date.now() + Math.random(),
                                data: dateStr,
                                tipo: typeKey,
                                fruito: isFruito
                            });
                        }
                    });

                    // Recupero spettanze se presenti
                    const spSheet = workbook.SheetNames.find(n => n.includes("Spettanze"));
                    if(spSheet) {
                        const spRows = XLSX.utils.sheet_to_json(workbook.Sheets[spSheet]);
                        spRows.forEach(row => {
                            if(row['Anno']) {
                                ensureYearInitialized(row['Anno']);
                                appState.yearsData[row['Anno']].spettanze = {
                                    ferie: row['Ferie'] || 0,
                                    festivita: row['Festività'] || 0,
                                    pir: row['PIR'] || 0,
                                    smonetizzazione: row['Smonetizzazione'] || 0
                                };
                            }
                        });
                    }

                    // Aggiorna baseYear in base ai dati importati (il più recente)
                    const years = Object.keys(appState.yearsData).map(Number).sort((a,b)=>b-a);
                    if(years.length > 0) {
                        appState.baseYear = years.includes(new Date().getFullYear()) ? new Date().getFullYear() : years[0];
                    }

                    saveData();
                    initUI();
                    alert("Importazione completata!");

                } catch (err) {
                    console.error(err);
                    alert("Errore importazione: " + err.message);
                } finally {
                    document.getElementById('file-input').value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        }

    </script>
</body>
</html>
